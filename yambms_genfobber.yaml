# CC1101 Fobber Template - Include this file and override substitutions
# This template includes all the CC1101 functionality with configurable pins and button codes

substitutions:

  # SPI Pin Configuration (LilyGo T-Connect header pins)
  spi_clk_pin: "14"    # IO14 - Safe
  spi_mosi_pin: "11"   # IO11 - Safe
  spi_miso_pin: "13"   # IO13 - Safe (avoiding IO48 strapping pin)

  # CC1101 Pin Configuration
  cc1101_cs_pin: "21"   # IO21 - Safe
  cc1101_gdo0_pin: "1"  # IO1 - GDO0 for TX
  cc1101_gdo2_pin: "42" # IO42 - GDO2 for RX

  # Dry Contact Input Pin
  dry_contact_pin: "38"  # IO38 - Safe
  dry_contact_inverted: "true"  # Set to false if button logic is inverted

  # Button 1 Transmission Code (raw format)
  button1_code: "339, -1161, 1071, -413, 1062, -423, 321, -1159, 330, -1144, 1064, -419, 324, -1171, 1064, -419, 1073, -413, 1062, -422, 319, -1163, 1055, -414, 1085, -419, 1068, -409, 336, -1145, 323, -1161, 1074, -413, 338, -1146, 319, -1165, 329, -1145, 337, -1158, 318, -1166, 335, -1146, 1073, -422, 327"

  # Button 2 Transmission Code (raw format)
  button2_code: "330, -1143, 1064, -419, 1075, -413, 337, -1150, 319, -1163, 1056, -433, 312, -1178, 1069, -408, 1061, -414, 1080, -417, 321, -1151, 1065, -421, 1067, -404, 1085, -406, 340, -1158, 321, -1150, 1061, -421, 319, -1165, 330, -1170, 302, -1182, 321, -1151, 334, -1146, 1067, -432, 334, -1146, 324"

  # Transmission Settings
  tx_repeat_times: "3"
  tx_repeat_wait: "15ms"


# SPI Bus Configuration
spi:
  - id: cc1101_spi_bus
    clk_pin: ${spi_clk_pin}
    mosi_pin: ${spi_mosi_pin}
    miso_pin: ${spi_miso_pin}

# CC1101 Configuration
cc1101:
  spi_id: cc1101_spi_bus
  cs_pin: ${cc1101_cs_pin}
  gdo0_pin:
    number: ${cc1101_gdo0_pin}
    allow_other_uses: true
  frequency: ${cc1101_frequency}


# Remote Transmitter (uses GDO0 - same pin as CC1101)

remote_transmitter:
  pin:
    number: ${cc1101_gdo0_pin}
    allow_other_uses: true
  carrier_duty_percent: 100%
  non_blocking: true
  on_transmit:
    then:
      - cc1101.begin_tx
  on_complete:
    then:
      - cc1101.begin_rx

# Remote Receiver (uses GDO2)
remote_receiver:
  pin: ${cc1101_gdo2_pin}
  dump:
    - raw

# Listen mode toggle
switch:
  - platform: template
    name: "CC1101 Listen Mode"
    id: listen_mode
    optimistic: true
    restore_mode: ALWAYS_OFF
    turn_on_action:
      - cc1101.begin_rx
    turn_off_action:
      - cc1101.set_idle

# Dry contact input for CC1101 transmission
binary_sensor:
  - platform: gpio
    name: "${friendly_name} Dry Contact"
    id: physical_button
    pin:
      number: ${dry_contact_pin}
      mode: INPUT
      inverted: ${dry_contact_inverted}
    filters:
      - delayed_on: 50ms
      - delayed_off: 50ms
    on_press:
      - logger.log: "Physical button pressed - triggering button 1"
      - button.press: cc1101_transmit_button_1
    on_release:
      - logger.log: "Physical button released - triggering button 2"
      - button.press: cc1101_transmit_button_2

# Transmit buttons
button:
  - platform: template
    name: "${friendly_name} Transmit Button 1"
    id: cc1101_transmit_button_1
    icon: mdi:alpha-1-circle-outline
    on_press:
      - logger.log: "Button 1: Starting transmission"
      - remote_transmitter.transmit_raw:
          code: !lambda |-
            return {${button1_code}};
          repeat:
            times: ${tx_repeat_times}
            wait_time: ${tx_repeat_wait}
      - logger.log: "Button 1: Transmission complete"

  - platform: template
    name: "${friendly_name} Transmit Button 2"
    id: cc1101_transmit_button_2
    icon: mdi:alpha-2-circle-outline
    on_press:
      - logger.log: "Button 2: Starting transmission"
      - remote_transmitter.transmit_raw:
          code: !lambda |-
            return {${button2_code}};
          repeat:
            times: ${tx_repeat_times}
            wait_time: ${tx_repeat_wait}
      - logger.log: "Button 2: Transmission complete"
